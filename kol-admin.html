<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title></title>
    <link rel="stylesheet" href="kol-admin.css?v=2.3">
    <link rel="stylesheet" href="page-builder.css?v=2.3">
    <link rel="stylesheet" href="page-renderer.css?v=2.3">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap"
        rel="stylesheet">
</head>

<body>
    <!-- 登入頁面 -->
    <div id="loginPage" class="login-container">
        <div class="login-box">
            <h2>🏪 團購主專區</h2>
            <p class="login-subtitle">登入管理您的賣場</p>
            <div class="form-group">
                <label>賣場 ID</label>
                <input type="text" id="kolStoreId" placeholder="輸入您的賣場 ID">
            </div>
            <div class="form-group">
                <label>密碼</label>
                <input type="password" id="kolPassword" placeholder="輸入密碼">
            </div>
            <button onclick="handleKolLogin()" id="loginBtn">登入</button>
            <p id="loginError" class="error-msg"></p>
        </div>
    </div>

    <!-- 主控台 -->
    <div id="dashboardPage" class="dashboard-container" style="display: none;">
        <nav class="sidebar">
            <div class="sidebar-header">
                <button class="mobile-close-sidebar" onclick="closeMobileSidebar()">×</button>
                <div id="storeLogoContainer"></div>
                <h3 id="storeNameHeader">我的賣場</h3>
            </div>
            <ul class="nav-links">
                <li id="tab-dashboard" class="active" onclick="kolSwitchTab('dashboard')" data-tooltip="業績總覽">
                    <span class="icon">◈</span><span class="text">業績總覽</span>
                </li>
                <li id="tab-products" onclick="kolSwitchTab('products')" data-tooltip="我的商品">
                    <span class="icon">◇</span><span class="text">我的商品</span>
                </li>
                <li id="tab-orders" onclick="kolSwitchTab('orders')" data-tooltip="訂單管理">
                    <span class="icon">☷</span><span class="text">訂單管理</span>
                </li>
                <li id="tab-settings" onclick="kolSwitchTab('settings')" data-tooltip="店舖設定">
                    <span class="icon">◎</span><span class="text">店舖設定</span>
                </li>
                <!-- 移除了排版管理，改為頁尾設定 -->
                <li id="tab-footer" onclick="kolSwitchTab('footer')" data-tooltip="頁尾設定">
                    <span class="icon">T</span><span class="text">頁尾設定</span>
                </li>
            </ul>
            <button class="sidebar-collapse-btn" onclick="toggleDesktopSidebar()" title="收合選單">⟨</button>
            <div class="sidebar-footer">
                <button onclick="kolLogout()">登出</button>
            </div>
        </nav>
        <div class="sidebar-overlay" onclick="closeMobileSidebar()"></div>

        <main class="main-content">
            <header class="top-bar">
                <button class="hamburger-btn" onclick="toggleMobileSidebar()">☰</button>
                <h2 id="pageTitle">業績總覽</h2>
                <div class="header-actions">
                    <a id="storeUrlLink" href="#" target="_blank" class="btn-outline">
                        前往我的商店 ↗
                    </a>
                </div>
            </header>

            <!-- 1. 業績總覽 -->
            <div id="dashboardView" class="view-section">
                <div class="stats-grid">
                    <div class="stat-card revenue">
                        <div class="stat-info">
                            <h3>本月銷售額</h3>
                            <p class="stat-value" id="dashRevenue">NT$ 0</p>
                        </div>
                    </div>
                    <div class="stat-card cost">
                        <div class="stat-info">
                            <h3>批發成本</h3>
                            <p class="stat-value" id="dashCost">NT$ 0</p>
                        </div>
                    </div>
                    <div class="stat-card profit highlight">
                        <div class="stat-info">
                            <h3>預估利潤</h3>
                            <p class="stat-value" id="dashProfit">NT$ 0</p>
                        </div>
                    </div>
                    <div class="stat-card orders">
                        <div class="stat-info">
                            <h3>訂單數</h3>
                            <p class="stat-value" id="dashOrders">0</p>
                        </div>
                    </div>
                </div>

                <div class="section-card">
                    <h3>最近訂單</h3>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>訂單編號</th>
                                <th>客戶</th>
                                <th>金額</th>
                                <th>狀態</th>
                                <th>日期</th>
                            </tr>
                        </thead>
                        <tbody id="recentOrdersBody">
                            <tr>
                                <td colspan="5" class="loading-cell">載入中...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- 2. 我的商品 -->
            <div id="productsView" class="view-section" style="display: none;">
                <div class="toolbar" style="flex-direction: column; gap:0.8rem;">
                    <button class="btn-primary" onclick="openProductPicker()" style="width:100%">+ 從商品庫選品</button>
                    <!-- 隱藏的建立專屬商品按鈕，保留供未來擴充
                    <button class="btn-secondary" onclick="openCreateOwnProduct()" style="display: none;">+ 建立專屬商品</button> 
                    -->

                    <div class="kol-search-row" style="display:flex; gap:0.5rem; width:100%;">
                        <input type="text" id="myProductSearch" placeholder="搜尋商品名稱..."
                            onkeydown="if(event.key === 'Enter') searchMyProducts()">
                        <button type="button" class="btn-search" onclick="searchMyProducts()">搜尋</button>
                    </div>

                    <button class="btn-save-all" onclick="saveAllProductPrices()" style="width:100%">💾 儲存所有變更</button>
                </div>

                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th style="width: 30px;"></th>
                                <th>圖片</th>
                                <th>商品名稱</th>
                                <th>批發價</th>
                                <th>我的售價</th>
                                <th>利潤</th>
                                <th>庫存</th>
                                <th>已售</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="myProductsBody">
                            <tr>
                                <td colspan="8" class="loading-cell">載入中...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- 3. 訂單管理 -->
            <div id="ordersView" class="view-section" style="display: none;">
                <div class="toolbar" style="justify-content: space-between; align-items: center;">
                    <div class="kol-search-row" style="flex: 1; display:flex; gap:0.5rem; flex-wrap:wrap;">
                        <button class="btn-add-order" onclick="openKolNewOrder()">+ 新增訂單</button>
                        <div style="display:flex; flex:1; gap:0.5rem;">
                            <input type="text" id="kolOrderSearch" placeholder="🔍 搜尋訂單編號、客戶姓名..."
                                onkeydown="if(event.key === 'Enter') filterKolOrders()">
                            <button type="button" class="btn-search" onclick="filterKolOrders()">搜尋</button>
                        </div>
                    </div>

                    <select id="kolOrderStatus" onchange="filterKolOrders()" style="min-width: 120px;">
                        <option value="">全部狀態</option>
                        <option value="待處理">待處理</option>
                        <option value="已確認">已確認</option>
                        <option value="已出貨">已出貨</option>
                        <option value="已完成">已完成</option>
                    </select>
                </div>

                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>訂單編號</th>
                                <th>日期</th>
                                <th>客戶</th>
                                <th>電話</th>
                                <th>商品</th>
                                <th>總額</th>
                                <th>狀態</th>
                            </tr>
                        </thead>
                        <tbody id="kolOrdersBody">
                            <tr>
                                <td colspan="7" class="loading-cell">載入中...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- 4. 業績統計 -->
            <div id="statsView" class="view-section" style="display: none;">
                <div class="filter-bar">
                    <div class="filter-group">
                        <label>統計週期：</label>
                        <select id="kolStatsMonth" onchange="loadKolMonthlyStats()">
                            <!-- 動態生成 -->
                        </select>
                    </div>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>總銷售額</h3>
                        <p class="stat-value" id="statsRevenue">NT$ 0</p>
                    </div>
                    <div class="stat-card">
                        <h3>批發成本</h3>
                        <p class="stat-value" id="statsCost">NT$ 0</p>
                    </div>
                    <div class="stat-card highlight">
                        <h3>淨利潤</h3>
                        <p class="stat-value" id="statsProfit">NT$ 0</p>
                    </div>
                    <div class="stat-card">
                        <h3>總訂單</h3>
                        <p class="stat-value" id="statsOrderCount">0</p>
                    </div>
                </div>

                <div class="section-card">
                    <h3>商品銷售排行</h3>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>商品名稱</th>
                                <th>規格</th>
                                <th>銷售數量</th>
                                <th>銷售額</th>
                            </tr>
                        </thead>
                        <tbody id="productRankingBody">
                            <tr>
                                <td colspan="4" class="loading-cell">載入中...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- 5. 店舖設定 -->
            <div id="settingsView" class="view-section" style="display: none;">
                <div class="settings-grid">
                    <div class="section-card">
                        <h3>🏪 賣場資料</h3>
                        <form id="profileForm" onsubmit="handleProfileUpdate(event)">
                            <div class="form-group">
                                <label>賣場 ID</label>
                                <input type="text" id="settingsStoreId" readonly class="readonly-input">
                            </div>
                            <div class="form-group">
                                <label>賣場名稱</label>
                                <input type="text" id="settingsStoreName" required>
                            </div>
                            <div class="form-group">
                                <label>賣場 Logo</label>
                                <div class="image-upload-area"
                                    style="padding:10px; border: 1px dashed #ddd; border-radius: 6px; text-align: center;">
                                    <div class="upload-zone" id="kolLogoUploadZone"
                                        onclick="document.getElementById('kolLogoFile').click()"
                                        style="padding: 1rem; cursor: pointer;">
                                        <div style="font-size: 1.5rem; margin-bottom: 5px;">📷</div>
                                        <p style="margin:0; font-size:0.9rem;">點擊更換 Logo</p>
                                    </div>
                                    <input type="file" id="kolLogoFile" style="display:none" accept="image/*"
                                        onchange="handleKolLogoSelect(event)">
                                    <div id="kolLogoPreviewContainer"
                                        style="margin-top:10px; position: relative; display: inline-block;">
                                        <img id="kolLogoPreview" src=""
                                            style="max-height:100px; display:none; border-radius: 4px; border: 1px solid #eee;">
                                        <button type="button" id="removeKolLogoBtn" onclick="removeKolLogo()"
                                            style="display:none; position: absolute; top:-5px; right:-5px; background:red; color:white; border:none; border-radius:50%; width:20px; height:20px; line-height:18px; cursor:pointer;">×</button>
                                    </div>
                                    <input type="hidden" id="settingsLogoUrl">
                                </div>
                            </div>
                            <div class="form-group">
                                <label>團購主姓名</label>
                                <input type="text" id="settingsOwnerName" required>
                            </div>
                            <div class="form-group">
                                <label>聯絡電話</label>
                                <input type="tel" id="settingsPhone">
                            </div>
                            <div class="form-group">
                                <label>Email</label>
                                <input type="email" id="settingsEmail">
                            </div>
                            <div class="form-group">
                                <label>品牌主題色 (#HEX)</label>
                                <div class="color-input-group">
                                    <input type="color" id="settingsThemeColorPicker" value="#6366f1">
                                    <input type="text" id="settingsThemeColor" placeholder="#6366f1">
                                </div>
                            </div>
                            <button type="submit" class="btn-primary" style="margin-top: 20px;">儲存設定</button>
                        </form>
                    </div>


                </div>
            </div>

            <!-- 6. 排版管理 (Page Builder) -->
            <div id="builderSection" class="view-section"
                style="display: none; padding: 0; height: calc(100vh - 70px); overflow: hidden;">
                <div class="visual-builder">
                    <!-- 左側：編輯區 -->
                    <div class="builder-sidebar">
                        <div class="components-list" id="builderComponentsList">
                            <!-- 由 page-builder.js 動態產生 -->
                        </div>
                        <div class="sidebar-footer">
                            <button class="save-btn" id="saveLayoutBtn" onclick="PageBuilder.saveLayout()">儲存排版</button>
                        </div>
                    </div>

                    <!-- 右側：預覽區 -->
                    <div class="builder-preview">
                        <div class="preview-toolbar">
                            <div class="device-toggles">
                                <button class="device-btn active" id="view-desktop"
                                    onclick="PageBuilder.setPreviewMode('desktop')">💻 電腦版</button>
                                <button class="device-btn" id="view-mobile"
                                    onclick="PageBuilder.setPreviewMode('mobile')">📱
                                    手機版</button>
                            </div>
                            <div class="preview-status">即時預覽中</div>
                        </div>
                        <div class="preview-viewport" id="previewViewport">
                            <div class="preview-container" id="pageBuilderPreviewRoot">
                                <!-- 由 page-renderer.js 動態渲染 -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 頁尾設定視圖 -->
            <div id="footerView" class="view-section" style="display: none;">
                <div class="view-header">
                    <h2>頁尾設定</h2>
                    <button class="accent-btn" onclick="saveKolFooter()">儲存設定</button>
                </div>
                <div class="card footer-settings-card">
                    <p class="helper-text">設定您商店頁尾顯示的資訊與社群連結。</p>

                    <div class="settings-group">
                        <div class="form-group">
                            <label>版權文字 (Copyright)</label>
                            <input type="text" id="footerCopyright"
                                placeholder="例如: © 2024 My Shop. All rights reserved.">
                        </div>
                    </div>

                    <div class="settings-group">
                        <h4 class="group-title">社群連結</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Facebook 連結</label>
                                <input type="text" id="footerFb" placeholder="https://facebook.com/...">
                            </div>
                            <div class="form-group">
                                <label>Instagram 連結</label>
                                <input type="text" id="footerIg" placeholder="https://instagram.com/...">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Line 連結</label>
                                <input type="text" id="footerLine" placeholder="https://line.me/...">
                            </div>
                            <div class="form-group">
                                <label>客服連結 (選填)</label>
                                <input type="text" id="footerSupport" placeholder="外部客服表單連結...">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- 商品選擇 Modal -->
    <div id="productPickerModal" class="modal">
        <div class="modal-content large-modal">
            <div class="modal-header">
                <h3>從商品庫選品</h3>
                <button class="close-btn" onclick="closeModal('productPickerModal')">✕</button>
            </div>
            <div class="modal-body">
                <div class="search-bar">
                    <input type="text" id="pickerSearchInput" placeholder="搜尋商品..." oninput="filterPickerProducts()">
                </div>
                <div class="product-grid" id="pickerProductGrid">
                    <!-- 動態載入商品卡片 -->
                </div>
            </div>
        </div>
    </div>

    <!-- 設定售價 Modal -->
    <div id="setPriceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>設定我的售價</h3>
                <button class="close-btn" onclick="closeModal('setPriceModal')">✕</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="priceProductId">
                <div class="product-info" id="priceProductInfo"></div>
                <div class="form-group">
                    <label>批發價 (成本)</label>
                    <p id="priceWholesale" class="price-display">NT$ 0</p>
                </div>
                <div class="form-group">
                    <label>我的售價 *</label>
                    <input type="number" id="priceCustom" required>
                </div>
                <div class="form-group">
                    <label>預估利潤</label>
                    <p id="priceProfit" class="profit-display">NT$ 0</p>
                </div>
            </div>
            <div class="modal-actions">
                <button onclick="closeModal('setPriceModal')">取消</button>
                <button class="accent-btn" onclick="confirmAddProduct()">確認新增</button>
            </div>
        </div>
    </div>



    <!-- Page Builder Add Component Modal -->
    <div class="modal" id="addCompModal">
        <div class="modal-content" style="width: 500px;">
            <h3>選擇要新增的區塊類型</h3>
            <div class="component-selector">
                <div class="comp-type-btn" onclick="PageBuilder.addComponent('hero'); closeModal('addCompModal')">
                    <span class="icon"></span><span>首頁大圖</span>
                </div>
                <div class="comp-type-btn" onclick="PageBuilder.addComponent('categories'); closeModal('addCompModal')">
                    <span class="icon"></span><span>分類導覽</span>
                </div>
                <div class="comp-type-btn" onclick="PageBuilder.addComponent('products'); closeModal('addCompModal')">
                    <span class="icon"></span><span>輪播圖</span>
                </div>
                <div class="comp-type-btn"
                    onclick="PageBuilder.addComponent('product_list'); closeModal('addCompModal')">
                    <span class="icon"></span><span>商品列表</span>
                </div>
                <div class="comp-type-btn"
                    onclick="PageBuilder.addComponent('image_carousel'); closeModal('addCompModal')">
                    <span class="icon"></span><span>圖片輪播</span>
                </div>
                <div class="comp-type-btn"
                    onclick="PageBuilder.addComponent('single_image'); closeModal('addCompModal')">
                    <span class="icon"></span><span>單張圖片</span>
                </div>
                <div class="comp-type-btn"
                    onclick="PageBuilder.addComponent('text_combination'); closeModal('addCompModal')">
                    <span class="icon"></span><span>文字組合</span>
                </div>
                <div class="comp-type-btn"
                    onclick="PageBuilder.addComponent('custom_code'); closeModal('addCompModal')">
                    <span class="icon"></span><span>程式碼</span>
                </div>
                <div class="comp-type-btn"
                    onclick="PageBuilder.addComponent('info_section'); closeModal('addCompModal')">
                    <span class="icon"></span><span>圖文介紹</span>
                </div>
                <div class="comp-type-btn"
                    onclick="PageBuilder.addComponent('announcement'); closeModal('addCompModal')">
                    <span class="icon"></span><span>公告欄</span>
                </div>
            </div>
            <div class="modal-actions" style="margin-top:2rem;">
                <button onclick="closeModal('addCompModal')">取消</button>
            </div>
        </div>
    </div>

    <!-- 編輯商品 Modal -->
    <div id="editProductModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>編輯商品</h3>
                <button class="close-btn" onclick="closeModal('editProductModal')">✕</button>
            </div>
            <div class="modal-body" id="editProductModalBody">
                <input type="hidden" id="editProductId">
                <div id="editProductInfo"
                    style="margin-bottom:20px; padding:10px; background:#f9f9f9; border-radius:8px;"></div>

                <div class="form-group">
                    <label>售價 <span style="color:red">*</span></label>
                    <input type="number" id="editProductPrice" placeholder="請輸入售價">
                </div>

                <div class="form-group">
                    <label>庫存狀態</label>
                    <input type="number" id="editProductStock" placeholder="設定庫存">
                    <small id="editStockHint"
                        style="color:#666; font-size:0.85em; margin-top:5px; display:block;">修改庫存會更新總部分配數量</small>
                </div>

                <div class="form-group">
                    <label>上架狀態</label>
                    <select id="editProductStatus" class="form-control">
                        <option value="active">上架中</option>
                        <option value="inactive">已下架</option>
                    </select>
                </div>
            </div>
            <div class="modal-actions" id="editProductModalActions">
                <!-- 動態注入按鈕 -->
            </div>
        </div>
    </div>

    <!-- 建立專屬商品 Modal -->
    <div id="createOwnProductModal" class="modal">
        <div class="modal-content large-modal">
            <div class="modal-header">
                <h3>建立專屬商品</h3>
                <button class="close-btn" onclick="closeModal('createOwnProductModal')">✕</button>
            </div>

            <form id="createOwnProductForm" onsubmit="submitOwnProduct(event)">
                <div class="modal-body">
                    <div class="form-row">
                        <div class="form-group" style="width:100%;">
                            <label>商品名稱 *</label>
                            <input type="text" id="ownProdName" required style="width:100%;">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group half">
                            <label>品牌</label>
                            <input type="text" id="ownProdBrand" placeholder="例如: Nike">
                        </div>
                        <div class="form-group half">
                            <label>分類</label>
                            <input type="text" id="ownProdCategory" list="categoryList">
                            <datalist id="categoryList">
                                <option value="流行服飾">
                                <option value="美妝保養">
                                <option value="零食食品">
                                <option value="生活用品">
                            </datalist>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group quarter">
                            <label>售價 (台幣) *</label>
                            <input type="number" id="ownProdPrice" required>
                        </div>
                        <div class="form-group quarter">
                            <label>成本 (自我管理用)</label>
                            <input type="number" id="ownProdCost">
                        </div>
                        <div class="form-group quarter">
                            <label>庫存 *</label>
                            <input type="number" id="ownProdStock" value="99" required>
                        </div>
                        <div class="form-group quarter">
                            <label>狀態</label>
                            <select id="ownProdStatus">
                                <option value="active">上架</option>
                                <option value="inactive">下架</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>商品描述</label>
                        <textarea id="ownProdDesc" rows="3"></textarea>
                    </div>

                    <div class="form-group">
                        <label>商品圖片</label>
                        <div class="image-upload-area">
                            <div class="upload-zone" onclick="document.getElementById('ownProductImageInput').click()">
                                <div class="upload-icon">📷</div>
                                <p>點擊上傳圖片</p>
                                <small>支援 JPG, PNG, WEBP</small>
                            </div>
                            <input type="file" id="ownProductImageInput" accept="image/*" multiple style="display:none"
                                onchange="handleKolImageSelect(event)">
                            <div class="image-preview-container" id="ownProductImagePreview"></div>
                            <input type="hidden" id="ownProdImages"> <!-- 儲存圖片 URL Array -->
                        </div>
                    </div>

                    <div class="form-group">
                        <label>規格設定</label>
                        <div id="ownSpecContainer" class="spec-builder-container">
                            <!-- 動態產生規格 -->
                        </div>
                        <button type="button" class="btn-small" onclick="addKolSpecGroup()" style="margin-top: 5px;">
                            + 新增規格類別
                        </button>
                    </div>

                    <!-- 規格明細表格 -->
                    <div class="form-group" id="ownVariantsSection" style="display: none;">
                        <label>規格明細</label>
                        <div class="variants-table-container">
                            <table class="variants-table">
                                <thead>
                                    <tr>
                                        <th>款式</th>
                                        <th width="100">價格</th>
                                        <th width="100">庫存</th>
                                    </tr>
                                </thead>
                                <tbody id="ownVariantsTableBody">
                                    <!-- 動態產生 -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                </div>
                <div class="modal-actions">
                    <button type="button" onclick="closeModal('createOwnProductModal')">取消</button>
                    <button type="submit" class="accent-btn" id="btnCreateOwn">建立商品</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 商品詳細資料 Modal -->
    <div id="productDetailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>商品詳細資料</h3>
                <button class="close-btn" onclick="closeModal('productDetailModal')">✕</button>
            </div>
            <div class="modal-body" id="productDetailModalBody">
                <!-- 由 JS 動態注入 -->
            </div>
            <div class="modal-actions">
                <button onclick="closeModal('productDetailModal')">關閉</button>
            </div>
        </div>
    </div>

    <!-- KOL 新增/編輯訂單 Modal (複製自 Admin) -->
    <div id="kolOrderModal" class="modal kol-order-modal">
        <div class="modal-content large-modal">
            <div class="modal-header">
                <h3><span id="kolModalTitle">新增訂單</span> <span id="kolDetailOrderId" class="badge"></span></h3>
                <button class="close-btn" onclick="closeModal('kolOrderModal')">✕</button>
            </div>

            <div class="modal-body">
                <div class="detail-section">
                    <div class="form-row" style="display:flex; justify-content:space-between; margin-bottom:1rem;">
                        <h4 style="margin:0;">訂單資訊</h4>
                        <div class="status-select">
                            <label>訂單狀態:</label>
                            <select id="kolDetailStatus">
                                <option value="待處理">待處理</option>
                                <option value="已確認">已確認</option>
                                <option value="已出貨">已出貨</option>
                                <option value="已完成">已完成</option>
                                <option value="已取消">已取消</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group half">
                            <label>訂單日期</label>
                            <input type="text" id="kolDetailDate" readonly class="readonly-input">
                        </div>
                        <div class="form-group half">
                            <label>訂購人姓名</label>
                            <input type="text" id="kolDetailName">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group half">
                            <label>電話</label>
                            <input type="tel" id="kolDetailPhone">
                        </div>
                        <div class="form-group half">
                            <label>Email (選填)</label>
                            <input type="email" id="kolDetailEmail">
                        </div>
                    </div>
                </div>

                <div class="detail-section">
                    <div class="form-row">
                        <div class="form-group">
                            <label>運送方式</label>
                            <select id="kolDetailShipping" onchange="updateKolShippingFee()">
                                <option value="7-11店到店">7-11店到店 (+60)</option>
                                <option value="限台中市面交">限台中市面交 (免運)</option>
                            </select>
                        </div>
                    </div>
                    <!-- 7-11 門市資訊 -->
                    <div id="kolDetailStoreInfo" class="store-info-group">
                        <div class="form-row">
                            <div class="form-group half">
                                <label>門市名稱</label>
                                <input type="text" id="kolDetailStoreName">
                            </div>
                            <div class="form-group half">
                                <label>門市店號</label>
                                <input type="text" id="kolDetailStoreCode">
                            </div>
                        </div>
                    </div>
                    <!-- 通用地址欄位 -->
                    <div class="form-group">
                        <label>地址 (門市或宅配)</label>
                        <input type="text" id="kolDetailStoreAddress">
                    </div>
                </div>

                <div class="detail-section">
                    <h4>商品明細 <button type="button" class="btn-primary" onclick="openKolAddProduct()"
                            style="float:right; padding:0.4rem 0.8rem; font-size:0.85rem;">+ 新增商品</button></h4>

                    <!-- 新增商品區域（隱藏） -->
                    <div id="kolAddProductArea"
                        style="display:none; margin-bottom:1rem; padding:1rem; background:#f8f9fa; border-radius:4px;">
                        <!-- 第一行：商品搜尋與數量 -->
                        <div class="form-row" style="display:flex; gap:1rem;">
                            <div class="form-group" style="flex:3;">
                                <label>選擇商品（可輸入搜尋）</label>
                                <input type="text" id="kolProductSearch" list="kolProductSuggestions"
                                    placeholder="輸入或選擇商品..." style="width:100%; padding:0.5rem;"
                                    oninput="onKolProductInput()">
                                <datalist id="kolProductSuggestions">
                                    <!-- 動態載入 -->
                                </datalist>
                            </div>
                            <div class="form-group quarter" style="flex:1;">
                                <label>數量</label>
                                <input type="number" id="kolProductQty" value="1" min="1">
                            </div>
                        </div>

                        <!-- 第二行：規格選擇 (獨立一行，避免被擠壓) -->
                        <div id="kolSpecSelectGroup"
                            style="display:none; margin-top: 0.5rem; padding: 0.5rem; background: #fff; border: 1px solid #eee; border-radius: 4px;">
                            <label style="display:block; margin-bottom:0.5rem; font-weight:bold;">規格選擇</label>
                            <div id="kolSpecSelectors" style="display: flex; gap: 1rem; flex-wrap: wrap;">
                                <!-- 動態生成多個規格選擇器 -->
                            </div>
                        </div>

                        <!-- 第三行：按鈕 -->
                        <div class="form-row" style="margin-top: 1rem; justify-content: flex-end; display:flex;">
                            <div class="form-group" style="flex:0 0 auto;">
                                <button type="button" onclick="addKolProductToOrderItems()"
                                    class="btn-primary">確認新增</button>
                                <button type="button" onclick="cancelKolAddProduct()" class="btn-outline"
                                    style="margin-left:0.5rem;">取消</button>
                            </div>
                        </div>
                    </div>

                    <div style="overflow-x:auto;">
                        <table class="data-table" style="min-width: 500px;">
                            <thead>
                                <tr>
                                    <th>商品</th>
                                    <th>規格</th>
                                    <th>數量</th>
                                    <th>單價</th>
                                    <th>小計</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="kolDetailItemsBody"></tbody>
                        </table>
                    </div>
                </div>

                <div class="detail-section">
                    <h4>訂單調整</h4>

                    <!-- 商品小計 -->
                    <div class="price-row" style="display:flex; justify-content:space-between; margin-bottom:0.5rem;">
                        <span>商品小計</span>
                        <span id="kolItemsSubtotal">NT$ 0</span>
                    </div>

                    <!-- 折扣率選項 -->
                    <div class="discount-options"
                        style="display:flex; align-items:center; gap:0.5rem; margin-bottom:0.5rem;">
                        <label style="display: flex; align-items: center;  gap: 0.5rem;">
                            <input type="checkbox" id="kolEnableDiscountPercent" onchange="updateKolOrderTotal()">
                            <span>啟用折扣率</span>
                        </label>
                        <input type="number" id="kolDiscountPercent" placeholder="90" min="0" max="100" step="1"
                            oninput="updateKolOrderTotal()" style="width: 60px; padding: 0.4rem;">
                        <span>%</span>
                        <span id="kolDiscountPercentAmount" style="color: #dc3545; margin-left: 1rem;">- NT$ 0</span>
                    </div>

                    <!-- 固定折扣選項 -->
                    <div class="discount-options"
                        style="display:flex; align-items:center; gap:0.5rem; margin-bottom:0.5rem;">
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" id="kolEnableDiscountAmount" onchange="updateKolOrderTotal()">
                            <span>固定折扣金額</span>
                        </label>
                        <input type="number" id="kolDiscountAmount" placeholder="100" min="0"
                            oninput="updateKolOrderTotal()" style="width: 80px; padding: 0.4rem;">
                        <span>元</span>
                    </div>

                    <!-- 運費 -->
                    <div class="price-row" style="display:flex; justify-content:space-between; margin-bottom:0.5rem;">
                        <span>運費</span>
                        <div>
                            <input type="number" id="kolDetailShippingFee" value="0" min="0"
                                oninput="updateKolOrderTotal()"
                                style="width: 80px; padding: 0.4rem; text-align: right;">
                            <span> 元</span>
                        </div>
                    </div>

                    <!-- 總計 -->
                    <div class="price-row total-row"
                        style="display:flex; justify-content:space-between; margin-top:1rem; font-size:1.2rem; border-top:1px solid #eee; padding-top:1rem;">
                        <span><strong>訂單總計</strong></span>
                        <span id="kolDetailTotal" style="color: var(--primary-color);"><strong>NT$ 0</strong></span>
                    </div>
                </div>

                <div class="detail-section">
                    <h4>備註</h4>
                    <textarea id="kolDetailNote" class="note-box" rows="3"
                        style="width:100%; border:1px solid #ddd; padding:0.5rem; border-radius:4px;"></textarea>
                </div>
            </div>
            <div class="modal-actions">
                <button onclick="closeModal('kolOrderModal')">取消</button>
                <button onclick="submitKolNewOrder()" class="accent-btn">確認建立訂單</button>
            </div>
        </div>
    </div>

    <!-- Toast 容器 -->
    <div id="toastContainer"></div>

    <script src="page-renderer.js"></script>
    <script src="page-builder.js"></script>
    <script src="kol-admin.js"></script>
</body>

</html>